name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - 'demo/**'

jobs:
  build:

    runs-on: ubuntu-latest

    env:
      MGFXC_WINE_PATH: /home/runner/.winemonogame

    strategy:
      matrix:
        runtime:
          - win-x64
          - linux-x64

    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET 6
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x

    - name: Setup Wine
      run: |
        sudo apt update
        sudo apt install wine64 p7zip-full
        wget -qO- https://raw.githubusercontent.com/MonoGame/MonoGame/master/Tools/MonoGame.Effect.Compiler/mgfxc_wine_setup.sh | sh

    - name: Restore dependencies
      run: dotnet restore Rpg.Client/Rpg.Client.sln

    - name: Build
      run: dotnet build Rpg.Client/Rpg.Client.sln --no-restore --verbosity diagnostic

    - name: Test
      run: dotnet test Rpg.Client/Rpg.Client.sln --no-build --verbosity normal

    - name: Publish
      run: dotnet publish Rpg/Client/Client.csproj --no-restore --verbosity diagnostic --output bin --runtime ${{ matrix.runtime }} --configuration Release --self-contained true
    - name: Get current time
      uses: srfrnk/current-time@master
      id: current-time
      with:
        format: YYYY-MM-DD
    
    - name: Write version to file
      uses: DamianReeves/write-file-action@v1.0
      env:
        F_TIME: "${{ steps.current-time.outputs.formattedTime }}"
      with:
        path: bin/version.txt
        contents: |
          ver 0.1-dev#${{ github.run_number }}
          ${{ env.F_TIME }}
          ${{ github.sha }}
        write-mode: overwrite

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v2.2.4
      env:
        F_TIME: "${{ steps.current-time.outputs.formattedTime }}"
      with:
        name: ewar-${{ matrix.runtime }}-v0.1-dev${{ github.run_number }}-${{ env.F_TIME }}
        path: bin
