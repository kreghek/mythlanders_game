name: Publish

on:
  workflow_dispatch:
  push:
    branches:
      - 'demo/**'

jobs:
  build:

    runs-on: ubuntu-latest

    env:
      MGFXC_WINE_PATH: /home/runner/.winemonogame

    strategy:
      matrix:
        runtime:
          - win
          - linux
          - mac

    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET 6
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x

    - name: Setup .NETCore 2.1
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 2.1.x

    - name: Setup Wine
      run: |
        sudo apt update
        sudo apt install wine64 p7zip-full
        wget -qO- https://raw.githubusercontent.com/MonoGame/MonoGame/master/Tools/MonoGame.Effect.Compiler/mgfxc_wine_setup.sh | sh
        cd ~/.winemonogame/drive_c/windows/system32

        DOTNET_URL="https://download.visualstudio.microsoft.com/download/pr/44d08222-aaa9-4d35-b24b-d0db03432ab7/52a4eb5922afd19e8e0d03e0dbbb41a0/dotnet-sdk-6.0.302-win-x64.zip"
        curl "https://download.visualstudio.microsoft.com/download/pr/44d08222-aaa9-4d35-b24b-d0db03432ab7/52a4eb5922afd19e8e0d03e0dbbb41a0/dotnet-sdk-6.0.302-win-x64.zip" --output "dotnet-sdk.zip"

        7z x "dotnet-sdk.zip" -y

        rm dotnet-sdk.zip


    - name: Restore dependencies
      run: dotnet restore Rpg.Client/Rpg.Client.sln

    - name: Build extentions
      run: dotnet build Rpg/GameContent.Extensions/GameContent.Extensions.csproj --configuration Release

    - name: Build
      run: dotnet build Rpg.Client/Rpg.Client.sln --verbosity normal

    - name: Test
      run: dotnet test Rpg.Client/Rpg.Client.sln --no-build --verbosity normal

    - name: Install GameBungle Tools
      run: dotnet tool install --global GameBundle

    - name: Publish
      run: gamebundle --source Rpg/Client/Client.csproj --output "bin" --${{matrix.runtime}}

    - name: Get current time
      uses: srfrnk/current-time@master
      id: current-time
      with:
        format: YYYY-MM-DD

    - name: Build Number (with base)
      uses: mlilback/build-number@v1.0.1
      id: build-number
      with:
        base: 71
        run-id: ${GITHUB_RUN_NUMBER}
    
    - name: Write version to file
      uses: DamianReeves/write-file-action@v1.0
      env:
        F_TIME: "${{ steps.current-time.outputs.formattedTime }}"
      with:
        path: bin/${{matrix.runtime}}/version.txt
        contents: |
          ver 0.2-dev.${{ steps.build-number.outputs.build-number }}
          ${{ env.F_TIME }}
          ${{ github.sha }}
        write-mode: overwrite

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v2.2.4
      env:
        F_TIME: "${{ steps.current-time.outputs.formattedTime }}"
      with:
        name: ewar-${{ matrix.runtime }}-v0.2-dev.${{ steps.build-number.outputs.build-number }}-${{ env.F_TIME }}
        path: bin
